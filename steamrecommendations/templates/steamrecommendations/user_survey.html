{% extends "steamrecommendations/base_generic.html" %}
{% load crispy_forms_tags %}

{% block title %}User Survey{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">Personalize Your Game Recommendations</h2>
                </div>
                <div class="card-body">
                    <p class="lead">
                        Tell us about your gaming preferences. You can also search for and add your favorite games below.
                    </p>
                    
                    <form method="post" action="{% url 'user_survey' %}" id="userSurveyForm">
                        {% csrf_token %}
                        
                        {{ form|crispy }}

                        <hr class="my-4">

                        <div class="mb-3">
                            <label for="gameSearchInput" class="form-label"><strong>Search and Add Favorite Games:</strong></label>
                            <div class="input-group mb-2">
                                <input type="text" id="gameSearchInput" class="form-control" placeholder="Type to search for games by title...">
                                <button type="button" id="gameSearchButton" class="btn btn-outline-secondary">Search</button>
                            </div>
                            <div id="gameSearchResults" class="list-group mb-3" style="max-height: 250px; overflow-y: auto; border: 1px solid #ced4da; border-radius: .25rem;">
                                <!-- Search results will appear here -->
                            </div>
                            
                            <label class="form-label"><strong>Your Selected Favorite Games (max 10):</strong></label>
                            <div id="selectedFavoriteGames" class="list-group mb-3">
                                <!-- Selected games will appear here -->
                                {% for game in existing_favorite_games %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center" data-game-id="{{ game.app_id }}">
                                        <span>{{ game.title }} (ID: {{ game.app_id }})</span>
                                        <button type="button" class="btn btn-sm btn-danger remove-favorite-game-btn" aria-label="Remove {{ game.title }}">Remove</button>
                                    </div>
                                {% endfor %}
                            </div>
                            <input type="hidden" name="favorite_game_ids" id="favoriteGameIdsInput">
                        </div>

                        <button type="submit" class="btn btn-success mt-3 w-100">Save Preferences & Get Recommendations</button>
                    </form>
                </div>
                <div class="card-footer text-muted">
                    Your preferences will be saved for future recommendations. You can update them anytime.
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* ... existing styles ... */
    div:has(.favorite_genres) .form-check {
        display: inline-block;
        margin-right: 10px;
        margin-bottom: 10px;
    }
    
    div:has(.favorite_genres) .form-check-label {
        display: inline-flex;
        align-items: center;
        padding: 6px 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    div:has(.favorite_genres) .form-check-label:hover {
        background-color: #f8f9fa;
    }
    
    div:has(.favorite_genres) .form-check-input:checked + .form-check-label {
        background-color: #cfe2ff;
        border-color: #0d6efd;
    }
    #gameSearchResults .list-group-item-action {
        cursor: pointer;
    }
    #gameSearchResults .list-group-item-action:hover {
        background-color: #f0f0f0;
    }
    #gameSearchResults .list-group-item-action.disabled {
        background-color: #e9ecef;
        opacity: 0.7;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const gameSearchInput = document.getElementById('gameSearchInput');
    const gameSearchButton = document.getElementById('gameSearchButton');
    const gameSearchResultsContainer = document.getElementById('gameSearchResults');
    const selectedFavoriteGamesContainer = document.getElementById('selectedFavoriteGames');
    const favoriteGameIdsInput = document.getElementById('favoriteGameIdsInput');
    const maxFavoriteGames = 10;

    let selectedGameIds = new Set();
    let searchTimeout;

    // Initialize selectedGameIds from existing games displayed by Django
    selectedFavoriteGamesContainer.querySelectorAll('.list-group-item').forEach(item => {
        const gameId = parseInt(item.dataset.gameId);
        if (!isNaN(gameId)) {
            selectedGameIds.add(gameId);
        }
    });
    updateFavoriteGameIdsInput();

    function updateFavoriteGameIdsInput() {
        favoriteGameIdsInput.value = Array.from(selectedGameIds).join(',');
    }

    function addGameToFavorites(gameId, gameTitle) {
        gameId = parseInt(gameId);
        if (selectedGameIds.has(gameId)) return;
        if (selectedGameIds.size >= maxFavoriteGames) {
            alert(`You can select a maximum of ${maxFavoriteGames} favorite games.`);
            return;
        }

        selectedGameIds.add(gameId);

        const listItem = document.createElement('div');
        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
        listItem.dataset.gameId = gameId;
        listItem.innerHTML = `
            <span>${gameTitle} (ID: ${gameId})</span>
            <button type="button" class="btn btn-sm btn-danger remove-favorite-game-btn" aria-label="Remove ${gameTitle}">Remove</button>
        `;
        selectedFavoriteGamesContainer.appendChild(listItem);
        updateFavoriteGameIdsInput();
        // Disable this game in search results if present
        const searchResultButton = gameSearchResultsContainer.querySelector(`.add-search-result-btn[data-game-id="${gameId}"]`);
        if (searchResultButton) {
            searchResultButton.disabled = true;
            searchResultButton.innerHTML += ' <span class="badge bg-secondary">Added</span>';
        }
    }

    function removeGameFromFavorites(gameId) {
        gameId = parseInt(gameId);
        selectedGameIds.delete(gameId);
        const itemToRemove = selectedFavoriteGamesContainer.querySelector(`[data-game-id="${gameId}"]`);
        if (itemToRemove) {
            itemToRemove.remove();
        }
        updateFavoriteGameIdsInput();
        // Re-enable this game in search results if present
        const searchResultButton = gameSearchResultsContainer.querySelector(`.add-search-result-btn[data-game-id="${gameId}"]`);
        if (searchResultButton) {
            searchResultButton.disabled = false;
            // Remove the "(Added)" badge if it exists
            const originalText = searchResultButton.dataset.gameTitle + ` (ID: ${searchResultButton.dataset.gameId})`;
            searchResultButton.innerHTML = originalText;
        }
    }

    async function performSearch() {
        const query = gameSearchInput.value.trim();
        if (query.length < 2) {
            gameSearchResultsContainer.innerHTML = '<div class="list-group-item text-muted">Enter at least 2 characters to search.</div>';
            return;
        }
        gameSearchResultsContainer.innerHTML = '<div class="list-group-item text-muted">Searching...</div>';

        try {
            const response = await fetch(`{% url 'ajax_search_games' %}?q=${encodeURIComponent(query)}`);
            if (!response.ok) throw new Error('Network response was not ok.');
            const data = await response.json();
            
            gameSearchResultsContainer.innerHTML = ''; // Clear previous results or "Searching..."

            if (data.games && data.games.length > 0) {
                data.games.forEach(game => {
                    const resultItem = document.createElement('button');
                    resultItem.type = 'button';
                    resultItem.className = 'list-group-item list-group-item-action add-search-result-btn';
                    resultItem.dataset.gameId = game.app_id;
                    resultItem.dataset.gameTitle = game.title; // Store original title
                    let buttonText = `${game.title} (ID: ${game.app_id})`;
                    
                    if (selectedGameIds.has(parseInt(game.app_id))) {
                        resultItem.disabled = true;
                        buttonText += ' <span class="badge bg-secondary">Added</span>';
                    }
                    resultItem.innerHTML = buttonText;
                    gameSearchResultsContainer.appendChild(resultItem);
                });
            } else {
                gameSearchResultsContainer.innerHTML = '<div class="list-group-item text-muted">No games found.</div>';
            }
        } catch (error) {
            console.error('Search error:', error);
            gameSearchResultsContainer.innerHTML = '<div class="list-group-item text-danger">Error searching. Please try again.</div>';
        }
    }

    gameSearchButton.addEventListener('click', performSearch);
    gameSearchInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            performSearch();
        }
    });
    
    gameSearchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 400); // Debounce: search after 400ms of no typing
    });

    gameSearchResultsContainer.addEventListener('click', function(event) {
        let targetButton = event.target;
        if (!targetButton.classList.contains('add-search-result-btn')) {
            targetButton = targetButton.closest('.add-search-result-btn');
        }

        if (targetButton && !targetButton.disabled) {
            const gameId = targetButton.dataset.gameId;
            const gameTitle = targetButton.dataset.gameTitle;
            addGameToFavorites(gameId, gameTitle);
        }
    });

    selectedFavoriteGamesContainer.addEventListener('click', function(event) {
        let targetButton = event.target;
         if (!targetButton.classList.contains('remove-favorite-game-btn')) {
            targetButton = targetButton.closest('.remove-favorite-game-btn');
        }
        if (targetButton) {
            const gameId = targetButton.closest('.list-group-item').dataset.gameId;
            removeGameFromFavorites(gameId);
        }
    });
});
</script>
{% endblock %}